"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6864],{6180:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>c,toc:()=>u});var r=t(4848),s=t(8453);const i=t.p+"assets/images/OAuth2-\u751f\u6210token\u6d41\u7a0b\u56fe-844afe523020dd8ba70c5c99cb258c91.png",a={},o="JAVA-oauth2\u6e90\u7801\u89e3\u8bfb",c={id:"java/JAVA-OAuth2-SourceCode",title:"JAVA-oauth2\u6e90\u7801\u89e3\u8bfb",description:"\u8bf7\u6c42token\u6e90\u7801\u89e3\u8bfb",source:"@site/docs/java/JAVA-OAuth2-SourceCode.md",sourceDirName:"java",slug:"/java/JAVA-OAuth2-SourceCode",permalink:"/mhuahe.com/docs/java/JAVA-OAuth2-SourceCode",draft:!1,unlisted:!1,editUrl:"https://github.dev/mhuahe/mhuahe.com/blob/master-ts/docs/java/JAVA-OAuth2-SourceCode.md",tags:[],version:"current",lastUpdatedBy:"heminhua",lastUpdatedAt:1729094642e3,frontMatter:{},sidebar:"java",previous:{title:"JAVA-MybatisPlus",permalink:"/mhuahe.com/docs/java/JAVA-MybatisPlus"},next:{title:"JAVA-PDF",permalink:"/mhuahe.com/docs/java/JAVA-PDF"}},l={},u=[{value:"\u8bf7\u6c42token\u6e90\u7801\u89e3\u8bfb",id:"\u8bf7\u6c42token\u6e90\u7801\u89e3\u8bfb",level:2},{value:"\u751f\u6210token\u6e90\u7801\u89e3\u8bfb",id:"\u751f\u6210token\u6e90\u7801\u89e3\u8bfb",level:2},{value:"\u9a8c\u8bc1token\u6d41\u7a0b",id:"\u9a8c\u8bc1token\u6d41\u7a0b",level:2}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"java-oauth2\u6e90\u7801\u89e3\u8bfb",children:"JAVA-oauth2\u6e90\u7801\u89e3\u8bfb"})}),"\n",(0,r.jsx)(n.h2,{id:"\u8bf7\u6c42token\u6e90\u7801\u89e3\u8bfb",children:"\u8bf7\u6c42token\u6e90\u7801\u89e3\u8bfb"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u8bbf\u95ee\uff1a",(0,r.jsx)(n.a,{href:"http://localhost:9992/oauth/token?client_id=hmh-cloud-system&client_secret=123456&grant_type=password&username=admin&password=1234&redirect_uri=http://www.taobao.com",children:"http://localhost:9992/oauth/token?client_id=hmh-cloud-system&client_secret=123456&grant_type=password&username=admin&password=1234&redirect_uri=http://www.taobao.com"})]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fdb\u5165AbstractAuthenticationProcessingFilter\u7684doFilter\u65b9\u6cd5"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8c03\u7528\u5b9e\u73b0\u7c7bClientCredentialsTokenEndpointFilter\u7684attemptAuthentication\u65b9\u6cd5\u8fdb\u884c\u9a8c\u8bc1"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u901a\u8fc7clientId\u548cclientSecret\u6784\u5efa\u672a\u8ba4\u8bc1\u7684UsernamePasswordAuthenticationToken\u5bf9\u8c61\uff0c\u8c03\u7528authenticate\u65b9\u6cd5\u5bf9\u5176\u8fdb\u884c\u8ba4\u8bc1"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'//ClientCredentialsTokenEndpointFilter\u7c7b\u7684attemptAuthentication\u65b9\u6cd5\r\n@Override\r\npublic Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response){\r\n    String clientId = request.getParameter("client_id");\r\n    String clientSecret = request.getParameter("client_secret");\r\n    // If the request is already authenticated we can assume that this\r\n    // filter is not needed\r\n    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();\r\n    if (authentication != null && authentication.isAuthenticated()) {\r\n        return authentication;\r\n    }\r\n    UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(clientId,clientSecret);\r\n    return this.getAuthenticationManager().authenticate(authRequest);\r\n}\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fdb\u5165ProviderManager\u7c7b\u7684authentication\u65b9\u6cd5\u4e2d\u5bf9AuthenticationProvider\u5217\u8868\u8fdb\u884c\u904d\u5386\uff0c\u76f4\u5230\u83b7\u5f97\u53ef\u4ee5\u5339\u914d\u4f20\u5165\u7684UsernamePasswordAuthenticationToken\u7c7b\u7684AuthenticationProvider\u7c7b\uff0c\u5373DaoAuthenticationProvider\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"//ProviderManager\u7c7b\u7684authentication\u65b9\u6cd5\r\npublic Authentication authenticate(Authentication authentication)\r\n    throws AuthenticationException {\r\n    Class<? extends Authentication> toTest = authentication.getClass();\r\n    for (AuthenticationProvider provider : getProviders()) {\r\n        if (!provider.supports(toTest)) {\r\n            continue;\r\n        }\r\n        try {\r\n            result = provider.authenticate(authentication);\r\n            if (result != null) {\r\n                copyDetails(authentication, result);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n    if (result != null) {\r\n        return result;\r\n    }\r\n}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fdb\u5165AbstractUserDetailsAuthenticationProvider\u7684authenticate\u65b9\u6cd5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'public Authentication authenticate(Authentication authentication){\r\n    // Determine username\r\n    String username = (authentication.getPrincipal() == null) ? "NONE_PROVIDED": authentication.getName();\r\n    UserDetails user = this.userCache.getUserFromCache(username);\r\n    if (user == null) {\r\n        try {\r\n            user = retrieveUser(username,(UsernamePasswordAuthenticationToken)authentication);\r\n        }\r\n    }\r\n    return createSuccessAuthentication(principalToReturn, authentication, user);\r\n}\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fdb\u5165DaoAuthenticationProvider\u7684retrieveUser\u65b9\u6cd5\u8c03\u7528loadUserByUsername\u65b9\u6cd5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"@Override\r\nprotected final UserDetails retrieveUser(String username, UsernamePasswordAuthenticationToken authentication){\r\n    try {\r\n        UserDetails loadedUser = this.getUserDetailsService().loadUserByUsername(username);\r\n        return loadedUser;\r\n    }\r\n}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fd4\u56deAbstractUserDetailsAuthenticationProvider\u7684authenticate\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.p,{children:"\u8c03\u7528 createSuccessAuthentication() \u8fd4\u56de\u8ba4\u8bc1\u4fe1\u606f"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"//AbstractUserDetailsAuthenticationProvider\u7684createSuccessAuthentication\u65b9\u6cd5\r\nprotected Authentication createSuccessAuthentication(Object principal,\r\nAuthentication authentication, UserDetails user) {\r\n    //\u5728\u8be5\u65b9\u6cd5\u4e2d\u521b\u5efa\u5df2\u8ba4\u8bc1\u7684UsernamePasswordAuthenticationToken\uff08\u5c06authenticated\u5c5e\u6027\u8bbe\u7f6e\u4e3atrue\uff09\uff0c\u5e76\u8bbe\u7f6eUserDetails\u540e\u8fd4\u56de\r\n    UsernamePasswordAuthenticationToken result = new UsernamePasswordAuthenticationToken(principal, authentication.getCredentials(),authoritiesMapper.mapAuthorities(user.getAuthorities()));\r\n    result.setDetails(authentication.getDetails());\r\n    return result;\r\n}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u6700\u540e\u8fd4\u56de\u8c03\u7528AbstractAuthenticationProcessingFilter\u7684successfulAuthentication\u65b9\u6cd5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u5728\u5176\u7236\u7c7b\u7684successfulAuthentication\u65b9\u6cd5\u4e2d\u5c06\u5df2\u8ba4\u8bc1\u7684UsernamePasswordAuthenticationToken\u653e\u7f6e\u5230\u5b89\u5168\u4e0a\u4e0b\u6587\u4e2d"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"//ClientCredentialsTokenEndpointFilter\u7684\u7236\u7c7bAbstractAuthenticationProcessingFilter\u7684successfulAuthentication\u65b9\u6cd5\r\nprotected void successfulAuthentication(HttpServletRequest request,\r\nHttpServletResponse response, FilterChain chain, Authentication authResult) {\r\n    SecurityContextHolder.getContext().setAuthentication(authResult);\r\n    rememberMeServices.loginSuccess(request, response, authResult);\r\n    // Fire event\r\n    if (this.eventPublisher != null) {\r\n        eventPublisher.publishEvent(new InteractiveAuthenticationSuccessEvent(\r\n            authResult, this.getClass()));\r\n    }\r\n    successHandler.onAuthenticationSuccess(request, response, authResult);\r\n}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u6700\u540e\u8c03\u7528\u4e0b\u4e00\u7ea7\u8fc7\u6ee4\u5668\u3002\u56e0\u4e3a\u5df2\u7ecf\u8bbe\u7f6e\u5230\u5b89\u5168\u4e0a\u4e0b\u6587\u4e2d\uff0c\u6240\u4ee5\u8fc7\u6ee4\u5668\u653e\u884c\uff0c\u8bf7\u6c42\u6700\u7ec8\u5230\u8fbeTokenEndpoint\u7c7b\u7684/oauth/token\u63a5\u53e3\u4e2d"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u751f\u6210token\u6e90\u7801\u89e3\u8bfb",children:"\u751f\u6210token\u6e90\u7801\u89e3\u8bfb"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u8fdb\u5165\u5230\u4e86TokenEndpoint\u7c7b\u7684/oauth/token\u63a5\u53e3"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@FrameworkEndpoint\r\npublic class TokenEndpoint extends AbstractEndpoint {\r\n    @RequestMapping(value = "/oauth/token", method=RequestMethod.POST)\r\n    public ResponseEntity<OAuth2AccessToken> postAccessToken(Principal principal, @RequestParam Map<String, String> parameters) {\r\n        // 1. \u4ece principal \u4e2d\u83b7\u53d6 clientId, \u8fdb\u800c load client \u4fe1\u606f\r\n        String clientId = getClientId(principal);\r\n        ClientDetails authenticatedClient = getClientDetailsService().loadClientByClientId(clientId);\r\n        // 2. \u4ece parameters \u4e2d\u62ff clientId\u3001scope\u3001grantType \u7ec4\u88c5 TokenRequest\r\n        TokenRequest tokenRequest = getOAuth2RequestFactory().createTokenRequest(parameters, authenticatedClient);\r\n        // 3. \u6821\u9a8c client \u4fe1\u606f\r\n        if (clientId != null && !clientId.equals("")) {\r\n            if (!clientId.equals(tokenRequest.getClientId())) {\r\n                // \u53cc\u91cd\u6821\u9a8c: \u786e\u4fdd\u4ece principal \u62ff\u5230\u7684 client \u4fe1\u606f\u4e0e\u6839\u636e parameters \u5f97\u5230\u7684 client \u4fe1\u606f\u4e00\u81f4\r\n                throw new InvalidClientException("Given client ID does not match authenticated client");\r\n            }\r\n        }\r\n        if (authenticatedClient != null) {\r\n            oAuth2RequestValidator.validateScope(tokenRequest, authenticatedClient);\r\n        }\r\n        // 4. \u6839\u636e grantType \u8bbe\u7f6e TokenRequest \u7684 scope\u3002\r\n        // \u6388\u6743\u7c7b\u578b\u6709: password \u6a21\u5f0f\u3001authorization_code \u6a21\u5f0f\u3001refresh_token \u6a21\u5f0f\u3001client_credentials \u6a21\u5f0f\u3001implicit \u6a21\u5f0f\r\n        if (!StringUtils.hasText(tokenRequest.getGrantType())) {\r\n            throw new InvalidRequestException("Missing grant type");\r\n        }\r\n        if (tokenRequest.getGrantType().equals("implicit")) {\r\n            throw new InvalidGrantException("Implicit grant type not supported from token endpoint");\r\n        }\r\n        // \u5982\u679c\u662f\u6388\u6743\u7801\u6a21\u5f0f, \u5219\u6e05\u7a7a\u4ece\u6570\u636e\u5e93\u67e5\u8be2\u5230\u7684 scope\u3002 \u56e0\u4e3a\u6388\u6743\u8bf7\u6c42\u8fc7\u7a0b\u4f1a\u786e\u5b9a scope, \u6240\u4ee5\u6ca1\u5fc5\u8981\u4f20\u3002\r\n        if (isAuthCodeRequest(parameters)) {\r\n            if (!tokenRequest.getScope().isEmpty()) {\r\n                logger.debug("Clearing scope of incoming token request");\r\n                tokenRequest.setScope(Collections.<String> emptySet());\r\n            }\r\n        }\r\n        // \u5982\u679c\u662f\u5237\u65b0 Token \u6a21\u5f0f, \u89e3\u6790\u5e76\u8bbe\u7f6e scope\r\n        if (isRefreshTokenRequest(parameters)) {\r\n            // A refresh token has its own default scopes, so we should ignore any added by the factory here.\r\n            tokenRequest.setScope(OAuth2Utils.parseParameterList(parameters.get(OAuth2Utils.SCOPE)));\r\n        }\r\n        // 5. \u901a\u8fc7\u4ee4\u724c\u6388\u4e88\u8005\u83b7\u53d6 token\r\n        OAuth2AccessToken token = getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);\r\n        if (token == null) {\r\n            throw new UnsupportedGrantTypeException("Unsupported grant type: " + tokenRequest.getGrantType());\r\n        }\r\n        return getResponse(token);\r\n    }\r\n}\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5404\u6388\u6743\u6a21\u5f0f\u5bf9\u5e94\u7684 TokenGranter"}),"\n"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"\u5b9e\u73b0\u7c7b"}),(0,r.jsx)(n.th,{children:"\u5bf9\u5e94\u7684\u6388\u6743\u6a21\u5f0f"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"AuthorizationCodeTokenGranter"}),(0,r.jsx)(n.td,{children:"\u6388\u6743\u7801\u6a21\u5f0f"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"ClientCredentialsTokenGranter"}),(0,r.jsx)(n.td,{children:"\u5ba2\u6237\u7aef\u6a21\u5f0f"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"ImplicitTokenGranter"}),(0,r.jsx)(n.td,{children:"implicit \u6a21\u5f0f"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"RefreshTokenGranter"}),(0,r.jsx)(n.td,{children:"\u5237\u65b0 token \u6a21\u5f0f"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"ResourceOwnerPasswordTokenGranter"}),(0,r.jsx)(n.td,{children:"\u5bc6\u7801\u6a21\u5f0f"})]})]})]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u901a\u8fc7getTokenGranter\u65b9\u6cd5\u83b7\u53d6AuthorizationServerEndpointsConfigurer\uff0c\u4ee5tokenRequest\u4f5c\u4e3a\u53c2\u6570\uff0c\u8c03\u7528grant\u65b9\u6cd5\u83b7\u53d6token"}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u8be5\u65b9\u6cd5\u4e2d\u8c03\u7528\u4e86CompositeTokenGranter\u7c7b\u7684grant\u65b9\u6cd5\uff0c"}),"\n",(0,r.jsxs)(n.p,{children:["CompositeTokenGranter\u7684\u5c5e\u6027",(0,r.jsx)(n.code,{children:"List<TokenGranter>"}),"\u4e2d\u5305\u542b\u4e86\u5982\u4e0b5\u79cd\u6388\u6743\u6a21\u5f0f\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"//CompositeTokenGranter\u7c7b\u7684grant\u65b9\u6cd5\r\npublic OAuth2AccessToken grant(String grantType, TokenRequest tokenRequest) {\r\nfor (TokenGranter granter : tokenGranters) {\r\n   OAuth2AccessToken grant = granter.grant(grantType, tokenRequest);\r\n   if (grant!=null) {\r\n       return grant;\r\n   }\r\n}\r\nreturn null;\r\n}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["\u904d\u5386",(0,r.jsx)(n.code,{children:"List<TokenGranter>"}),"\u5bfb\u627e\u5408\u9002\u7684TokenGranter\uff0c\u8c03\u7528grant\u65b9\u6cd5\u8fd4\u56de\u751f\u6210\u7684OAuth2AccessToken\u3002\u5176\u5b50\u7c7b\u7ee7\u627f\u4e86grant\u65b9\u6cd5\uff0c\u5224\u65ad\u6bcf\u4e2a\u5b50\u7c7b\u7684grantType\u5c5e\u6027\u662f\u5426\u548c\u8bf7\u6c42\u7684grantType\u4e00\u81f4\uff0c\u6700\u7ec8\u5339\u914d\u5230",(0,r.jsx)(n.strong,{children:"ResourceOwnerPasswordTokenGranter"}),"\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'//AbstractTokenGranter\u7c7b\u7684grant\uff0cgetAccessToken\u548c\u65b9\u6cd5\r\npublic OAuth2AccessToken grant(String grantType, TokenRequest tokenRequest) {\r\n    if (!this.grantType.equals(grantType)) {\r\n        return null;\r\n    }\r\n    String clientId = tokenRequest.getClientId();\r\n    ClientDetails client = clientDetailsService.loadClientByClientId(clientId);\r\n    validateGrantType(grantType, client);\r\n    if (logger.isDebugEnabled()) {\r\n        logger.debug("Getting access token for: " + clientId);\r\n    }\r\n    return getAccessToken(client, tokenRequest);\r\n}\r\nprotected OAuth2AccessToken getAccessToken(ClientDetails client, TokenRequest tokenRequest) {\r\n    return tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));\r\n}\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"createAccessToken\u65b9\u6cd5\u7684\u53c2\u6570\u662fOAuth2Authentication\uff0c\u901a\u8fc7getOAuth2Authentication\u65b9\u6cd5\u83b7\u5f97\uff0cResourceOwnerPasswordTokenGranter\u91cd\u5199\u4e86\u7236\u7c7b\u7684\u8be5\u65b9\u6cd5"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Override\r\nprotected OAuth2Authentication getOAuth2Authentication(ClientDetails client, TokenRequest tokenRequest) {\r\n Map<String, String> parameters = new LinkedHashMap<String, String>(tokenRequest.getRequestParameters());\r\n String username = parameters.get("username");\r\n String password = parameters.get("password");\r\n // Protect from downstream leaks of password\r\n parameters.remove("password");\r\n Authentication userAuth = new UsernamePasswordAuthenticationToken(username, password);\r\n ((AbstractAuthenticationToken) userAuth).setDetails(parameters);\r\n try {\r\n     userAuth = authenticationManager.authenticate(userAuth);\r\n }\r\n if (userAuth == null || !userAuth.isAuthenticated()) {\r\n     throw new InvalidGrantException("Could not authenticate user: " + username);\r\n }\r\n OAuth2Request storedOAuth2Request = getRequestFactory().createOAuth2Request(client, tokenRequest);\t\t\r\n return new OAuth2Authentication(storedOAuth2Request, userAuth);\r\n}\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8c03\u7528AuthorizationServerTokenServices\u7684\u5b50\u7c7bDefaultTokenServices\u7684createAccessToken\u65b9\u6cd5\u751f\u6210OAuth2AccessToken\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u8be5\u65b9\u6cd5\u4f7f\u7528\u4e86tokenStore.getAccessToken(authentication)\u6765\u83b7\u53d6\u7684token\u3002\u5982\u679cgetAccessToken\u8fd4\u56de\u7684token\u662fnull\uff0c\u5219\u76f4\u63a5\u521b\u5efa\u65b0\u7684token\uff1b\u5982\u679cgetAccessToken\u8fd4\u56de\u4e86\u6301\u4e45\u5316\u7684token\uff0c\u5219\u5224\u65adtoken\u662f\u5426\u8fc7\u671f\uff0c\u5982\u679c\u672a\u8fc7\u671f\u5219\u6839\u636eOAuth2Authentication \u4fe1\u606f\u91cd\u65b0\u5b58\u50a8token\u4ee5\u9632\u4fe1\u606f\u53d8\u66f4"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u5728DefaultTokenServices\u7684createAccessToken\u65b9\u6cd5\u4e2d\u521b\u5efaDefaultOAuth2AccessToken \u5e76\u5c06expiration\u3001refreshToken\u3001scopes\u7b49\u4fe1\u606f\u5b58\u50a8\u5230\u5176\u4e2d\uff0c\u5f97\u5230token"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"//DefaultTokenServices\u7c7b\r\nprivate OAuth2AccessToken createAccessToken(OAuth2Authentication authentication, OAuth2RefreshToken refreshToken) {\r\nString tokenValue = new String(Base64.encodeBase64URLSafe(DEFAULT_TOKEN_GENERATOR.generateKey()),  US_ASCII);\r\nDefaultOAuth2AccessToken token = new DefaultOAuth2AccessToken(tokenValue);\r\nint validitySeconds = getAccessTokenValiditySeconds(authentication.getOAuth2Request());\r\nif (validitySeconds > 0) {\r\n   token.setExpiration(new Date(System.currentTimeMillis() + (validitySeconds * 1000L)));\r\n}\r\ntoken.setRefreshToken(refreshToken);\r\ntoken.setScope(authentication.getOAuth2Request().getScope());\r\nreturn accessTokenEnhancer != null ? accessTokenEnhancer.enhance(token, authentication) : token;\r\n}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u5728\u6700\u540e\u4f1a\u901a\u8fc7accessTokenEnhancer\u7684enhance\u65b9\u6cd5\u5bf9\u8be5token\u8fdb\u884c\u5f3a\u5316"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public class TokenEnhancerChain implements TokenEnhancer {\r\nprivate List<TokenEnhancer> delegates = Collections.emptyList();\r\n/**\r\n    * @param delegates the delegates to set\r\n    */\r\n   public void setTokenEnhancers(List<TokenEnhancer> delegates) {\r\n       this.delegates = delegates;\r\n   }\r\n   /**\r\n    * Loop over the {@link #setTokenEnhancers(List) delegates} passing the result into the next member of the chain.\r\n    */\r\n   public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {\r\n       OAuth2AccessToken result = accessToken;\r\n       for (TokenEnhancer enhancer : delegates) {\r\n           result = enhancer.enhance(result, authentication);\r\n       }\r\n       return result;\r\n   }\r\n}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["\u6b64\u5904\u4f1a\u904d\u5386",(0,r.jsx)(n.code,{children:"List<TokenEnhancer>"}),"\u5bfb\u627e\u5408\u9002\u7684 TokenEnhancer \uff0c\u5e76\u8c03\u7528enhance\u65b9\u6cd5\u5bf9OAuth2AccessToken \u8fdb\u884c\u52a0\u5f3a\u3002"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u6700\u540e\u5728TokenEndpoint\u7c7b\u4e2d\u8c03\u7528getResponse\u65b9\u6cd5\u5c06OAuth2AccessToken \u8bbe\u7f6e\u5230\u8fd4\u56de\u53c2\u6570\u4e2d"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'//TokenEndpoint\u7c7b\u7684getResponse\u65b9\u6cd5\r\nprivate ResponseEntity<OAuth2AccessToken> getResponse(OAuth2AccessToken accessToken) {\r\n    HttpHeaders headers = new HttpHeaders();\r\n    headers.set("Cache-Control", "no-store");\r\n    headers.set("Pragma", "no-cache");\r\n    headers.set("Content-Type", "application/json;charset=UTF-8");\r\n    return new ResponseEntity<OAuth2AccessToken>(accessToken, headers, HttpStatus.OK);\r\n}\n'})}),"\n","\n",(0,r.jsx)("img",{src:i,alt:"OAuth2-\u751f\u6210token\u6d41\u7a0b\u56fe",width:"50%"}),"\n",(0,r.jsx)(n.h2,{id:"\u9a8c\u8bc1token\u6d41\u7a0b",children:"\u9a8c\u8bc1token\u6d41\u7a0b"})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(6540);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);