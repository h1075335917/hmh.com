"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6864],{3187:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>u});let r=JSON.parse('{"id":"java/JAVA-OAuth2-SourceCode","title":"JAVA-oauth2\u6E90\u7801\u89E3\u8BFB","description":"\u8BF7\u6C42token\u6E90\u7801\u89E3\u8BFB","source":"@site/docs/java/JAVA-OAuth2-SourceCode.md","sourceDirName":"java","slug":"/java/JAVA-OAuth2-SourceCode","permalink":"/mhuahe.com/docs/java/JAVA-OAuth2-SourceCode","draft":false,"unlisted":false,"editUrl":"https://github.dev/mhuahe/mhuahe.com/blob/master-ts/docs/java/JAVA-OAuth2-SourceCode.md","tags":[],"version":"current","lastUpdatedBy":"heminhua","lastUpdatedAt":1729094642000,"frontMatter":{},"sidebar":"java","previous":{"title":"JAVA-MybatisPlus","permalink":"/mhuahe.com/docs/java/JAVA-MybatisPlus"},"next":{"title":"JAVA-PDF","permalink":"/mhuahe.com/docs/java/JAVA-PDF"}}');var s=t(4848),i=t(8453);let a=t.p+"assets/images/OAuth2-\u751F\u6210token\u6D41\u7A0B\u56FE-844afe523020dd8ba70c5c99cb258c91.png",o={},c="JAVA-oauth2\u6E90\u7801\u89E3\u8BFB",l={},u=[{value:"\u8BF7\u6C42token\u6E90\u7801\u89E3\u8BFB",id:"\u8BF7\u6C42token\u6E90\u7801\u89E3\u8BFB",level:2},{value:"\u751F\u6210token\u6E90\u7801\u89E3\u8BFB",id:"\u751F\u6210token\u6E90\u7801\u89E3\u8BFB",level:2},{value:"\u9A8C\u8BC1token\u6D41\u7A0B",id:"\u9A8C\u8BC1token\u6D41\u7A0B",level:2}];function h(e){let n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"java-oauth2\u6E90\u7801\u89E3\u8BFB",children:"JAVA-oauth2\u6E90\u7801\u89E3\u8BFB"})}),"\n",(0,s.jsx)(n.h2,{id:"\u8BF7\u6C42token\u6E90\u7801\u89E3\u8BFB",children:"\u8BF7\u6C42token\u6E90\u7801\u89E3\u8BFB"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u8BBF\u95EE\uFF1A",(0,s.jsx)(n.a,{href:"http://localhost:9992/oauth/token?client_id=hmh-cloud-system&client_secret=123456&grant_type=password&username=admin&password=1234&redirect_uri=http://www.taobao.com",children:"http://localhost:9992/oauth/token?client_id=hmh-cloud-system&client_secret=123456&grant_type=password&username=admin&password=1234&redirect_uri=http://www.taobao.com"})]}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u8FDB\u5165AbstractAuthenticationProcessingFilter\u7684doFilter\u65B9\u6CD5"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u8C03\u7528\u5B9E\u73B0\u7C7BClientCredentialsTokenEndpointFilter\u7684attemptAuthentication\u65B9\u6CD5\u8FDB\u884C\u9A8C\u8BC1"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u901A\u8FC7clientId\u548CclientSecret\u6784\u5EFA\u672A\u8BA4\u8BC1\u7684UsernamePasswordAuthenticationToken\u5BF9\u8C61\uFF0C\u8C03\u7528authenticate\u65B9\u6CD5\u5BF9\u5176\u8FDB\u884C\u8BA4\u8BC1"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'//ClientCredentialsTokenEndpointFilter\u7C7B\u7684attemptAuthentication\u65B9\u6CD5\r\n@Override\r\npublic Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response){\r\n    String clientId = request.getParameter("client_id");\r\n    String clientSecret = request.getParameter("client_secret");\r\n    // If the request is already authenticated we can assume that this\r\n    // filter is not needed\r\n    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();\r\n    if (authentication != null && authentication.isAuthenticated()) {\r\n        return authentication;\r\n    }\r\n    UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(clientId,clientSecret);\r\n    return this.getAuthenticationManager().authenticate(authRequest);\r\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u8FDB\u5165ProviderManager\u7C7B\u7684authentication\u65B9\u6CD5\u4E2D\u5BF9AuthenticationProvider\u5217\u8868\u8FDB\u884C\u904D\u5386\uFF0C\u76F4\u5230\u83B7\u5F97\u53EF\u4EE5\u5339\u914D\u4F20\u5165\u7684UsernamePasswordAuthenticationToken\u7C7B\u7684AuthenticationProvider\u7C7B\uFF0C\u5373DaoAuthenticationProvider\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"//ProviderManager\u7C7B\u7684authentication\u65B9\u6CD5\r\npublic Authentication authenticate(Authentication authentication)\r\n    throws AuthenticationException {\r\n    Class<? extends Authentication> toTest = authentication.getClass();\r\n    for (AuthenticationProvider provider : getProviders()) {\r\n        if (!provider.supports(toTest)) {\r\n            continue;\r\n        }\r\n        try {\r\n            result = provider.authenticate(authentication);\r\n            if (result != null) {\r\n                copyDetails(authentication, result);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n    if (result != null) {\r\n        return result;\r\n    }\r\n}\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u8FDB\u5165AbstractUserDetailsAuthenticationProvider\u7684authenticate\u65B9\u6CD5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public Authentication authenticate(Authentication authentication){\r\n    // Determine username\r\n    String username = (authentication.getPrincipal() == null) ? "NONE_PROVIDED": authentication.getName();\r\n    UserDetails user = this.userCache.getUserFromCache(username);\r\n    if (user == null) {\r\n        try {\r\n            user = retrieveUser(username,(UsernamePasswordAuthenticationToken)authentication);\r\n        }\r\n    }\r\n    return createSuccessAuthentication(principalToReturn, authentication, user);\r\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u8FDB\u5165DaoAuthenticationProvider\u7684retrieveUser\u65B9\u6CD5\u8C03\u7528loadUserByUsername\u65B9\u6CD5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"@Override\r\nprotected final UserDetails retrieveUser(String username, UsernamePasswordAuthenticationToken authentication){\r\n    try {\r\n        UserDetails loadedUser = this.getUserDetailsService().loadUserByUsername(username);\r\n        return loadedUser;\r\n    }\r\n}\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u8FD4\u56DEAbstractUserDetailsAuthenticationProvider\u7684authenticate\u65B9\u6CD5"}),"\n",(0,s.jsx)(n.p,{children:"\u8C03\u7528 createSuccessAuthentication() \u8FD4\u56DE\u8BA4\u8BC1\u4FE1\u606F"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"//AbstractUserDetailsAuthenticationProvider\u7684createSuccessAuthentication\u65B9\u6CD5\r\nprotected Authentication createSuccessAuthentication(Object principal,\r\nAuthentication authentication, UserDetails user) {\r\n    //\u5728\u8BE5\u65B9\u6CD5\u4E2D\u521B\u5EFA\u5DF2\u8BA4\u8BC1\u7684UsernamePasswordAuthenticationToken\uFF08\u5C06authenticated\u5C5E\u6027\u8BBE\u7F6E\u4E3Atrue\uFF09\uFF0C\u5E76\u8BBE\u7F6EUserDetails\u540E\u8FD4\u56DE\r\n    UsernamePasswordAuthenticationToken result = new UsernamePasswordAuthenticationToken(principal, authentication.getCredentials(),authoritiesMapper.mapAuthorities(user.getAuthorities()));\r\n    result.setDetails(authentication.getDetails());\r\n    return result;\r\n}\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u6700\u540E\u8FD4\u56DE\u8C03\u7528AbstractAuthenticationProcessingFilter\u7684successfulAuthentication\u65B9\u6CD5"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u5728\u5176\u7236\u7C7B\u7684successfulAuthentication\u65B9\u6CD5\u4E2D\u5C06\u5DF2\u8BA4\u8BC1\u7684UsernamePasswordAuthenticationToken\u653E\u7F6E\u5230\u5B89\u5168\u4E0A\u4E0B\u6587\u4E2D"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"//ClientCredentialsTokenEndpointFilter\u7684\u7236\u7C7BAbstractAuthenticationProcessingFilter\u7684successfulAuthentication\u65B9\u6CD5\r\nprotected void successfulAuthentication(HttpServletRequest request,\r\nHttpServletResponse response, FilterChain chain, Authentication authResult) {\r\n    SecurityContextHolder.getContext().setAuthentication(authResult);\r\n    rememberMeServices.loginSuccess(request, response, authResult);\r\n    // Fire event\r\n    if (this.eventPublisher != null) {\r\n        eventPublisher.publishEvent(new InteractiveAuthenticationSuccessEvent(\r\n            authResult, this.getClass()));\r\n    }\r\n    successHandler.onAuthenticationSuccess(request, response, authResult);\r\n}\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u6700\u540E\u8C03\u7528\u4E0B\u4E00\u7EA7\u8FC7\u6EE4\u5668\u3002\u56E0\u4E3A\u5DF2\u7ECF\u8BBE\u7F6E\u5230\u5B89\u5168\u4E0A\u4E0B\u6587\u4E2D\uFF0C\u6240\u4EE5\u8FC7\u6EE4\u5668\u653E\u884C\uFF0C\u8BF7\u6C42\u6700\u7EC8\u5230\u8FBETokenEndpoint\u7C7B\u7684/oauth/token\u63A5\u53E3\u4E2D"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u751F\u6210token\u6E90\u7801\u89E3\u8BFB",children:"\u751F\u6210token\u6E90\u7801\u89E3\u8BFB"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u8FDB\u5165\u5230\u4E86TokenEndpoint\u7C7B\u7684/oauth/token\u63A5\u53E3"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@FrameworkEndpoint\r\npublic class TokenEndpoint extends AbstractEndpoint {\r\n    @RequestMapping(value = "/oauth/token", method=RequestMethod.POST)\r\n    public ResponseEntity<OAuth2AccessToken> postAccessToken(Principal principal, @RequestParam Map<String, String> parameters) {\r\n        // 1. \u4ECE principal \u4E2D\u83B7\u53D6 clientId, \u8FDB\u800C load client \u4FE1\u606F\r\n        String clientId = getClientId(principal);\r\n        ClientDetails authenticatedClient = getClientDetailsService().loadClientByClientId(clientId);\r\n        // 2. \u4ECE parameters \u4E2D\u62FF clientId\u3001scope\u3001grantType \u7EC4\u88C5 TokenRequest\r\n        TokenRequest tokenRequest = getOAuth2RequestFactory().createTokenRequest(parameters, authenticatedClient);\r\n        // 3. \u6821\u9A8C client \u4FE1\u606F\r\n        if (clientId != null && !clientId.equals("")) {\r\n            if (!clientId.equals(tokenRequest.getClientId())) {\r\n                // \u53CC\u91CD\u6821\u9A8C: \u786E\u4FDD\u4ECE principal \u62FF\u5230\u7684 client \u4FE1\u606F\u4E0E\u6839\u636E parameters \u5F97\u5230\u7684 client \u4FE1\u606F\u4E00\u81F4\r\n                throw new InvalidClientException("Given client ID does not match authenticated client");\r\n            }\r\n        }\r\n        if (authenticatedClient != null) {\r\n            oAuth2RequestValidator.validateScope(tokenRequest, authenticatedClient);\r\n        }\r\n        // 4. \u6839\u636E grantType \u8BBE\u7F6E TokenRequest \u7684 scope\u3002\r\n        // \u6388\u6743\u7C7B\u578B\u6709: password \u6A21\u5F0F\u3001authorization_code \u6A21\u5F0F\u3001refresh_token \u6A21\u5F0F\u3001client_credentials \u6A21\u5F0F\u3001implicit \u6A21\u5F0F\r\n        if (!StringUtils.hasText(tokenRequest.getGrantType())) {\r\n            throw new InvalidRequestException("Missing grant type");\r\n        }\r\n        if (tokenRequest.getGrantType().equals("implicit")) {\r\n            throw new InvalidGrantException("Implicit grant type not supported from token endpoint");\r\n        }\r\n        // \u5982\u679C\u662F\u6388\u6743\u7801\u6A21\u5F0F, \u5219\u6E05\u7A7A\u4ECE\u6570\u636E\u5E93\u67E5\u8BE2\u5230\u7684 scope\u3002 \u56E0\u4E3A\u6388\u6743\u8BF7\u6C42\u8FC7\u7A0B\u4F1A\u786E\u5B9A scope, \u6240\u4EE5\u6CA1\u5FC5\u8981\u4F20\u3002\r\n        if (isAuthCodeRequest(parameters)) {\r\n            if (!tokenRequest.getScope().isEmpty()) {\r\n                logger.debug("Clearing scope of incoming token request");\r\n                tokenRequest.setScope(Collections.<String> emptySet());\r\n            }\r\n        }\r\n        // \u5982\u679C\u662F\u5237\u65B0 Token \u6A21\u5F0F, \u89E3\u6790\u5E76\u8BBE\u7F6E scope\r\n        if (isRefreshTokenRequest(parameters)) {\r\n            // A refresh token has its own default scopes, so we should ignore any added by the factory here.\r\n            tokenRequest.setScope(OAuth2Utils.parseParameterList(parameters.get(OAuth2Utils.SCOPE)));\r\n        }\r\n        // 5. \u901A\u8FC7\u4EE4\u724C\u6388\u4E88\u8005\u83B7\u53D6 token\r\n        OAuth2AccessToken token = getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);\r\n        if (token == null) {\r\n            throw new UnsupportedGrantTypeException("Unsupported grant type: " + tokenRequest.getGrantType());\r\n        }\r\n        return getResponse(token);\r\n    }\r\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5404\u6388\u6743\u6A21\u5F0F\u5BF9\u5E94\u7684 TokenGranter"}),"\n"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u5B9E\u73B0\u7C7B"}),(0,s.jsx)(n.th,{children:"\u5BF9\u5E94\u7684\u6388\u6743\u6A21\u5F0F"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"AuthorizationCodeTokenGranter"}),(0,s.jsx)(n.td,{children:"\u6388\u6743\u7801\u6A21\u5F0F"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ClientCredentialsTokenGranter"}),(0,s.jsx)(n.td,{children:"\u5BA2\u6237\u7AEF\u6A21\u5F0F"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ImplicitTokenGranter"}),(0,s.jsx)(n.td,{children:"implicit \u6A21\u5F0F"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"RefreshTokenGranter"}),(0,s.jsx)(n.td,{children:"\u5237\u65B0 token \u6A21\u5F0F"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ResourceOwnerPasswordTokenGranter"}),(0,s.jsx)(n.td,{children:"\u5BC6\u7801\u6A21\u5F0F"})]})]})]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u901A\u8FC7getTokenGranter\u65B9\u6CD5\u83B7\u53D6AuthorizationServerEndpointsConfigurer\uFF0C\u4EE5tokenRequest\u4F5C\u4E3A\u53C2\u6570\uFF0C\u8C03\u7528grant\u65B9\u6CD5\u83B7\u53D6token"}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u8BE5\u65B9\u6CD5\u4E2D\u8C03\u7528\u4E86CompositeTokenGranter\u7C7B\u7684grant\u65B9\u6CD5\uFF0C"}),"\n",(0,s.jsxs)(n.p,{children:["CompositeTokenGranter\u7684\u5C5E\u6027",(0,s.jsx)(n.code,{children:"List<TokenGranter>"}),"\u4E2D\u5305\u542B\u4E86\u5982\u4E0B5\u79CD\u6388\u6743\u6A21\u5F0F\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"//CompositeTokenGranter\u7C7B\u7684grant\u65B9\u6CD5\r\npublic OAuth2AccessToken grant(String grantType, TokenRequest tokenRequest) {\r\nfor (TokenGranter granter : tokenGranters) {\r\n   OAuth2AccessToken grant = granter.grant(grantType, tokenRequest);\r\n   if (grant!=null) {\r\n       return grant;\r\n   }\r\n}\r\nreturn null;\r\n}\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["\u904D\u5386",(0,s.jsx)(n.code,{children:"List<TokenGranter>"}),"\u5BFB\u627E\u5408\u9002\u7684TokenGranter\uFF0C\u8C03\u7528grant\u65B9\u6CD5\u8FD4\u56DE\u751F\u6210\u7684OAuth2AccessToken\u3002\u5176\u5B50\u7C7B\u7EE7\u627F\u4E86grant\u65B9\u6CD5\uFF0C\u5224\u65AD\u6BCF\u4E2A\u5B50\u7C7B\u7684grantType\u5C5E\u6027\u662F\u5426\u548C\u8BF7\u6C42\u7684grantType\u4E00\u81F4\uFF0C\u6700\u7EC8\u5339\u914D\u5230",(0,s.jsx)(n.strong,{children:"ResourceOwnerPasswordTokenGranter"}),"\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'//AbstractTokenGranter\u7C7B\u7684grant\uFF0CgetAccessToken\u548C\u65B9\u6CD5\r\npublic OAuth2AccessToken grant(String grantType, TokenRequest tokenRequest) {\r\n    if (!this.grantType.equals(grantType)) {\r\n        return null;\r\n    }\r\n    String clientId = tokenRequest.getClientId();\r\n    ClientDetails client = clientDetailsService.loadClientByClientId(clientId);\r\n    validateGrantType(grantType, client);\r\n    if (logger.isDebugEnabled()) {\r\n        logger.debug("Getting access token for: " + clientId);\r\n    }\r\n    return getAccessToken(client, tokenRequest);\r\n}\r\nprotected OAuth2AccessToken getAccessToken(ClientDetails client, TokenRequest tokenRequest) {\r\n    return tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));\r\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"createAccessToken\u65B9\u6CD5\u7684\u53C2\u6570\u662FOAuth2Authentication\uFF0C\u901A\u8FC7getOAuth2Authentication\u65B9\u6CD5\u83B7\u5F97\uFF0CResourceOwnerPasswordTokenGranter\u91CD\u5199\u4E86\u7236\u7C7B\u7684\u8BE5\u65B9\u6CD5"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Override\r\nprotected OAuth2Authentication getOAuth2Authentication(ClientDetails client, TokenRequest tokenRequest) {\r\n Map<String, String> parameters = new LinkedHashMap<String, String>(tokenRequest.getRequestParameters());\r\n String username = parameters.get("username");\r\n String password = parameters.get("password");\r\n // Protect from downstream leaks of password\r\n parameters.remove("password");\r\n Authentication userAuth = new UsernamePasswordAuthenticationToken(username, password);\r\n ((AbstractAuthenticationToken) userAuth).setDetails(parameters);\r\n try {\r\n     userAuth = authenticationManager.authenticate(userAuth);\r\n }\r\n if (userAuth == null || !userAuth.isAuthenticated()) {\r\n     throw new InvalidGrantException("Could not authenticate user: " + username);\r\n }\r\n OAuth2Request storedOAuth2Request = getRequestFactory().createOAuth2Request(client, tokenRequest);		\r\n return new OAuth2Authentication(storedOAuth2Request, userAuth);\r\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u8C03\u7528AuthorizationServerTokenServices\u7684\u5B50\u7C7BDefaultTokenServices\u7684createAccessToken\u65B9\u6CD5\u751F\u6210OAuth2AccessToken\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u8BE5\u65B9\u6CD5\u4F7F\u7528\u4E86tokenStore.getAccessToken(authentication)\u6765\u83B7\u53D6\u7684token\u3002\u5982\u679CgetAccessToken\u8FD4\u56DE\u7684token\u662Fnull\uFF0C\u5219\u76F4\u63A5\u521B\u5EFA\u65B0\u7684token\uFF1B\u5982\u679CgetAccessToken\u8FD4\u56DE\u4E86\u6301\u4E45\u5316\u7684token\uFF0C\u5219\u5224\u65ADtoken\u662F\u5426\u8FC7\u671F\uFF0C\u5982\u679C\u672A\u8FC7\u671F\u5219\u6839\u636EOAuth2Authentication \u4FE1\u606F\u91CD\u65B0\u5B58\u50A8token\u4EE5\u9632\u4FE1\u606F\u53D8\u66F4"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u5728DefaultTokenServices\u7684createAccessToken\u65B9\u6CD5\u4E2D\u521B\u5EFADefaultOAuth2AccessToken \u5E76\u5C06expiration\u3001refreshToken\u3001scopes\u7B49\u4FE1\u606F\u5B58\u50A8\u5230\u5176\u4E2D\uFF0C\u5F97\u5230token"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"//DefaultTokenServices\u7C7B\r\nprivate OAuth2AccessToken createAccessToken(OAuth2Authentication authentication, OAuth2RefreshToken refreshToken) {\r\nString tokenValue = new String(Base64.encodeBase64URLSafe(DEFAULT_TOKEN_GENERATOR.generateKey()),  US_ASCII);\r\nDefaultOAuth2AccessToken token = new DefaultOAuth2AccessToken(tokenValue);\r\nint validitySeconds = getAccessTokenValiditySeconds(authentication.getOAuth2Request());\r\nif (validitySeconds > 0) {\r\n   token.setExpiration(new Date(System.currentTimeMillis() + (validitySeconds * 1000L)));\r\n}\r\ntoken.setRefreshToken(refreshToken);\r\ntoken.setScope(authentication.getOAuth2Request().getScope());\r\nreturn accessTokenEnhancer != null ? accessTokenEnhancer.enhance(token, authentication) : token;\r\n}\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u5728\u6700\u540E\u4F1A\u901A\u8FC7accessTokenEnhancer\u7684enhance\u65B9\u6CD5\u5BF9\u8BE5token\u8FDB\u884C\u5F3A\u5316"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"public class TokenEnhancerChain implements TokenEnhancer {\r\nprivate List<TokenEnhancer> delegates = Collections.emptyList();\r\n/**\r\n    * @param delegates the delegates to set\r\n    */\r\n   public void setTokenEnhancers(List<TokenEnhancer> delegates) {\r\n       this.delegates = delegates;\r\n   }\r\n   /**\r\n    * Loop over the {@link #setTokenEnhancers(List) delegates} passing the result into the next member of the chain.\r\n    */\r\n   public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {\r\n       OAuth2AccessToken result = accessToken;\r\n       for (TokenEnhancer enhancer : delegates) {\r\n           result = enhancer.enhance(result, authentication);\r\n       }\r\n       return result;\r\n   }\r\n}\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["\u6B64\u5904\u4F1A\u904D\u5386",(0,s.jsx)(n.code,{children:"List<TokenEnhancer>"}),"\u5BFB\u627E\u5408\u9002\u7684 TokenEnhancer \uFF0C\u5E76\u8C03\u7528enhance\u65B9\u6CD5\u5BF9OAuth2AccessToken \u8FDB\u884C\u52A0\u5F3A\u3002"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u6700\u540E\u5728TokenEndpoint\u7C7B\u4E2D\u8C03\u7528getResponse\u65B9\u6CD5\u5C06OAuth2AccessToken \u8BBE\u7F6E\u5230\u8FD4\u56DE\u53C2\u6570\u4E2D"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'//TokenEndpoint\u7C7B\u7684getResponse\u65B9\u6CD5\r\nprivate ResponseEntity<OAuth2AccessToken> getResponse(OAuth2AccessToken accessToken) {\r\n    HttpHeaders headers = new HttpHeaders();\r\n    headers.set("Cache-Control", "no-store");\r\n    headers.set("Pragma", "no-cache");\r\n    headers.set("Content-Type", "application/json;charset=UTF-8");\r\n    return new ResponseEntity<OAuth2AccessToken>(accessToken, headers, HttpStatus.OK);\r\n}\n'})}),"\n","\n",(0,s.jsx)("img",{src:a,alt:"OAuth2-\u751F\u6210token\u6D41\u7A0B\u56FE",width:"50%"}),"\n",(0,s.jsx)(n.h2,{id:"\u9A8C\u8BC1token\u6D41\u7A0B",children:"\u9A8C\u8BC1token\u6D41\u7A0B"})]})}function d(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(6540);let s={},i=r.createContext(s);function a(e){let n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);